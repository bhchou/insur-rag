image: docker:24-git

workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - when: never

stages:
  - build
  - deploy-dev

services:
  - name: docker:24-dind
    alias: docker
    command: ["--tls=false"]

variables:
  # CI_REGISTRY_IMAGE æœƒè‡ªå‹•æŠ“å–ç•¶å‰å°ˆæ¡ˆçš„ Registry è·¯å¾‘
  CI_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_BUILDKIT: 1
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
  tags:
    - rasp_arm64
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_IMAGE:$CI_COMMIT_TAG .
    - docker push $CI_IMAGE:$CI_COMMIT_TAG

deploy:
  stage: deploy-dev
  rules:
    - if: $CI_COMMIT_TAG
  image: line/kubectl-kustomize
  tags:
    - rasp_arm64
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk update && apk add openssh-client )'
    - 'command -v git >/dev/null || ( apk update && apk add git )'
    - eval $(ssh-agent -s)
    # âš ï¸ è¨˜å¾—åœ¨ GitLab CI/CD Settings è£¡è¨­å®š SSH_PRIVATE_KEY
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
    
    # ğŸ”¥ ä¿®æ”¹ 1: å°ˆæ¡ˆ Git URL æ”¹ç‚º insur-rag
    - git remote set-url origin git@gitlab.com:choustudio/insur_rag.git
    
    - git remote get-url origin
    - git config --global user.email "bhchou@gmail.com"
    - git config --global user.name "Jack Chou"
  script:
    - git checkout -B main
    - cd k8s
    
    # ğŸ”¥ ä¿®æ”¹ 2: Kustomize image name æ”¹ç‚º rag_web
    # é€™æœƒæŠŠ kustomization.yaml è£¡çš„ newTag æ›æˆç•¶å‰çš„ CI_COMMIT_TAG
    - kustomize edit set image rag_web=$CI_IMAGE:$CI_COMMIT_TAG
    
    - cat kustomization.yaml
    - git commit -am "[skip ci] insur-rag image update to $CI_COMMIT_TAG"
    - git push origin main