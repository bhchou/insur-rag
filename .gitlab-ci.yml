stages:
  - build
  - update-manifest

variables:
  # è¨­å®šæ‚¨çš„ Manifest Repo ä½å€ (è«‹ä¿®æ”¹ç‚ºæ‚¨çš„å¯¦éš›ä½å€)
  # æ ¼å¼å¿…é ˆæ˜¯ SSH (git@...) æ‰èƒ½ä½¿ç”¨ Deploy Key
  MANIFEST_REPO: "git@gitlab.com:choustudio/insur-rag-manifests.git"
  
  # Image åç¨±å®šç¾©
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  LATEST_TAG: $CI_REGISTRY_IMAGE:latest
  
  # Git å„ªåŒ–
  GIT_DEPTH: "1"

# ==========================================
# ğŸ—ï¸ Build Stage: å»ºç½®ä¸¦æ¨é€ (ä½¿ç”¨ Docker Socket)
# ==========================================
build-job:
  stage: build
  # ç›´æ¥ç”¨ docker cliï¼Œå®ƒæœƒé€éæ›è¼‰çš„ socket é€£åˆ° Pi 5 çš„ Docker Daemon
  image: docker:27-cli
  tags:
    - rasp_arm64
  # åªæœ‰æ‰“ Tag æ™‚æ‰åŸ·è¡Œ
  rules:
    - if: $CI_COMMIT_TAG

  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

  script:
    - echo "ğŸ—ï¸ Building Docker Image on Pi 5 (Native Speed)..."
    
    # å˜—è©¦æ‹‰å– latest ç•¶ä½œå¿«å–ä¾†æº (åŠ é€Ÿç·¨è­¯)
    - docker pull $LATEST_TAG || true
    
    # å»ºç½® Image
    # --cache-from: ä½¿ç”¨å®¿ä¸»æ©Ÿä¸Šç¾æœ‰çš„ Layer
    - docker build --cache-from $LATEST_TAG -t $IMAGE_TAG -t $LATEST_TAG .
    
    # æ¨é€
    - echo "ğŸš€ Pushing image..."
    - docker push $IMAGE_TAG
    - docker push $LATEST_TAG

# ==========================================
# ğŸ“ Manifest Stage: ä¿®æ”¹ Config Repo (GitOps)
# ==========================================
update-manifest-job:
  stage: update-manifest
  # ä½¿ç”¨å«æœ‰ git å’Œ ssh çš„è¼•é‡æ˜ åƒæª”
  image: bitnami/git:latest
  tags:
    - rasp_arm64
  rules:
    - if: $CI_COMMIT_TAG

  before_script:
    # 1. è¨­å®š SSH Key (å¾è®Šæ•¸è®€å–ç§é‘°)
    - mkdir -p ~/.ssh
    - echo "$GITOPS_SSH_PRIV_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    
    # 2. ç•¥é Host Key æª¢æŸ¥ (é¿å… CI å¡åœ¨ "Are you sure?")
    - echo -e "Host gitlab.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
    
    # 3. è¨­å®šæ©Ÿå™¨äººèº«åˆ†
    - git config --global user.email "ci-bot@gmail.com"
    - git config --global user.name "CI Bot"

  script:
    - echo "ğŸ”„ Cloning manifest repo..."
    - git clone --depth 1 $MANIFEST_REPO manifest-repo
    - cd manifest-repo
    
    # å‡è¨­æ‚¨çš„ yaml æ”¾åœ¨ k8s/ è³‡æ–™å¤¾ä¸‹
    - cd k8s
    
    - echo "âœï¸ Updating kustomization.yaml to version $CI_COMMIT_TAG..."
    
    # ä½¿ç”¨ sed ç›´æ¥æ›¿æ› newTag çš„å€¼
    # å‡è¨­åŸæœ¬æ ¼å¼æ˜¯ newTag: xxxxx
    - 'sed -i "s/newTag: .*/newTag: \"$CI_COMMIT_TAG\"/" kustomization.yaml'
    
    # æª¢æŸ¥ä¿®æ”¹çµæœ (å°å‡ºä¾†ç¢ºèª)
    - cat kustomization.yaml | grep newTag
    
    # æäº¤ä¸¦æ¨é€
    - git add kustomization.yaml
    - 'git commit -m "chore(release): update rag-web image to $CI_COMMIT_TAG"'
    - git push origin main
    
    - echo "âœ… Manifest updated! ArgoCD will sync shortly."