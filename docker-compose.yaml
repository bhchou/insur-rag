#version: '3.8'

services:
  web:
#    build: 
#      context: .
    image: bhchou/insur-rag:v1
    container_name: rag_web
    ports:
      - "8081:8081"
    
    # 1. è®€å–æ‚¨çš„ .env æª”æ¡ˆ (è¼‰å…¥ LLM è¨­å®šã€Keyã€RAG åƒæ•¸)
    env_file:
      - .env

    # 2. ç’°å¢ƒè®Šæ•¸è¦†å¯« (é‡å° Docker ç’°å¢ƒçš„ä¿®æ­£)
    environment:
      # [ä¿®æ­£ DB è·¯å¾‘] 
      # å¼·åˆ¶å®¹å™¨å…§éƒ¨è®€å–é€™å€‹æ›è¼‰é»ï¼Œå¿½ç•¥ .env æˆ– Global Constant
      - LANCEDB_PATH=/app/lancedb_data

      # [ä¿®æ­£ Reranker é€£ç·š] 
      # æ‚¨çš„ .env å¯«çš„æ˜¯ localhostï¼Œä½†åœ¨å®¹å™¨å…§è¦æ”¹æˆ host.docker.internal æ‰èƒ½é€£å› WSL2
      - RERANK_API_URL=http://host.docker.internal:8009/rerank
      
      # [System Prompt è·¯å¾‘]
      # ç¢ºä¿èˆ‡å®¹å™¨å…§çš„è·¯å¾‘ä¸€è‡´ (WORKDIR æ˜¯ /appï¼Œæ‰€ä»¥æ˜¯ relative path)
      - SYSTEM_PROMPT_PATH=./data/system_prompt.txt

      # ğŸ”¥ [é—œéµä¿®æ­£ 2] è®“ Rust ç¨‹å¼åŸ·è¡Œæ™‚ä¹Ÿèƒ½é Proxy
      - NO_PROXY=localhost,127.0.0.1,host.docker.internal
      # å°å¯«çš„é€šå¸¸ä¹Ÿè¦è¨­ï¼Œä»¥é˜²è¬ä¸€
      - no_proxy=localhost,127.0.0.1,host.docker.internal
      - REDIS_URL=redis://redis:6379/
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
        # å¼·åˆ¶æŒ‡å®šå¿«å–ä½ç½®ï¼Œä¸å†ä¾è³´é è¨­å€¼
      - FASTEMBED_CACHE_PATH=/app/data/model_cache

    volumes:
      # [å‰ç«¯ç†±æ›´æ–°]
      - ./frontend:/app/frontend

      # [System Prompt] å¤§è…¦è¨­å®š
      - ./data/system_prompt.txt:/app/data/system_prompt.txt

      # [è³‡æ–™åº«] æŠŠå®¿ä¸»æ©Ÿçš„ data/lancedb_insure æ›é€²å»
      # âš ï¸ è«‹ç¢ºèªå®¿ä¸»æ©Ÿçš„é€™å€‹è·¯å¾‘æ˜¯æ­£ç¢ºçš„ DB ä½ç½®
      - ./data/lancedb_insure:/app/lancedb_data
      - ./data/processed_json:/app/data/processed_json
      - ./data/model_cache:/app/data/model_cache

    depends_on:
      - redis  
    # è®“å®¹å™¨å¯ä»¥é€£åˆ° WSL2 (ç‚ºäº† Re-ranker)
    extra_hosts:
      - "host.docker.internal:host-gateway"

  redis:
    image: "redis:7.0-alpine"
    container_name: rag_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  redis_data:
