services:
  web:
    image: bhchou/insur-rag:v2
    container_name: rag_web
    ports:
      - "8081:8081" # å°å¤–é–‹æ”¾ Port
    
    env_file:
      - .env

    environment:
      # [è³‡æ–™åº«èˆ‡æ¨¡å‹è·¯å¾‘]
      - LANCEDB_PATH=/app/lancedb_data
      - SYSTEM_PROMPT_PATH=./data/system_prompt.txt
      - FASTEMBED_CACHE_PATH=/app/data/model_cache
      
      # [Redis é€£ç·š]
      # ğŸ”¥ é‡é» 1: åœ¨ Bridge æ¨¡å¼ä¸‹ï¼Œç›´æ¥ç”¨ service åç¨± "redis" ç•¶ä½œä¸»æ©Ÿåç¨±
      # Docker å…§éƒ¨çš„ DNS æœƒè‡ªå‹•å¹«ä½ è§£æå‡ºæ­£ç¢º IP
      - REDIS_URL=redis://rag_redis:6379/

      # [Rerank Server é€£ç·š]
      # ğŸ”¥ é‡é» 2: ä½¿ç”¨ host.docker.internal é€£å›å®¿ä¸»æ©Ÿ (WSL2)
      # å³ä½¿æ˜¯åœ¨ Linux ä¸Šï¼Œåªè¦é…åˆä¸‹é¢çš„ extra_hosts è¨­å®šï¼Œé€™æ‹›ä¹Ÿé€šç”¨ï¼
      - RERANK_API_URL=http://host.docker.internal:8009/rerank

      # [Proxy è¨­å®š] è®“ç¨‹å¼èƒ½æ­£ç¢ºç¹é Proxy é€£åˆ°è‡ªå·±å’Œ Host
      - NO_PROXY=localhost,127.0.0.1,host.docker.internal,rag_redis
      - no_proxy=localhost,127.0.0.1,host.docker.internal,rag_redis

      # [æ¬Šé™è¨­å®š]
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}

    volumes:
      #- ./frontend:/app/frontend
      - ./data/system_prompt.txt:/app/data/system_prompt.txt
      - ./data/lancedb_insure:/app/lancedb_data
      #- ./data/processed_json:/app/data/processed_json
      - ./data/model_cache:/app/data/model_cache

    depends_on:
      - redis

    # ğŸ”¥ é‡é» 3: é€™è¡Œæ˜¯é—œéµï¼
    # å®ƒæœƒå‘Šè¨´å®¹å™¨ï¼š"host.docker.internal" å°æ‡‰åˆ° Docker çš„ç¶²é—œ IP (172.x.x.1 æˆ– 10.x.x.1)
    # é€™æ¨£å®¹å™¨å°±èƒ½é€éé€™å€‹åå­—é€£å›ä½ çš„ WSL2 Python Server
    extra_hosts:
      - "host.docker.internal:host-gateway"

  redis:
    image: "redis:7.0-alpine"
    container_name: rag_redis
    # Bridge æ¨¡å¼ä¸‹ï¼ŒRedis ä¸ä¸€å®šè¦æŠŠ Port 6379 éœ²çµ¦å¤–é¢ (WSL2)ï¼Œ
    # åªè¦éœ²çµ¦åŒå€‹ç¶²è·¯å…§çš„ web å®¹å™¨å³å¯ã€‚ä½†ç‚ºäº†æ–¹ä¾¿é™¤éŒ¯ï¼Œç•™è‘—ä¹Ÿæ²’å·®ã€‚
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  redis_data: