apiVersion: apps/v1
kind: Deployment
metadata:
  name: rag-web
  labels:
    app: insur-rag
spec:
  replicas: 1
  # ğŸ”¥ é‡è¦ï¼šRWO ç¡¬ç¢Ÿä¸æ”¯æ´å¤š Pod åŒæ™‚å¯«å…¥ï¼Œæ›´æ–°æ™‚å¿…é ˆå…ˆæ®ºèˆŠçš„
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: insur-rag
  template:
    metadata:
      labels:
        app: insur-rag
    spec:
      # æ‹‰å– Private Image ç”¨çš„ Secret (GitLab Registry)
      imagePullSecrets:
        - name: gitlab-registry-auth
      
      containers:
        # --- [1] ä¸»ç¨‹å¼ (Rust RAG) ---
        - name: rag-web
          image: rag_web # Kustomize æœƒè‡ªå‹•æ›¿æ›æˆå®Œæ•´ Image URL
          imagePullPolicy: Always
          ports:
            - containerPort: 8081 # Rust App çš„ Port
          
          # æ³¨å…¥ ConfigMap è£¡çš„è®Šæ•¸ (PATH éƒ½åœ¨é€™è£¡)
          envFrom:
            - configMapRef:
                name: rag-config
          
          env:
            # Redis é€£ç·š (æŒ‡å‘ Helm éƒ¨ç½²çš„ Service)
            - name: REDIS_URL
              value: "redis://my-redis-master.redis-system.svc.cluster.local:6379/"
            
            # Rerank API (é€£å› Mac)
            # é€™æ˜¯ Mac åœ¨ Tailscale ç¶²åŸŸå…§çš„ IP (ä¾‹å¦‚ 100.x.y.z)
            # å› ç‚ºæœ‰ Sidecarï¼ŒPod å¯ä»¥ç›´æ¥ ping é€šé€™å€‹ IP
            - name: RERANK_API_URL
              value: "http://100.94.212.86:8009/rerank" 

          # æ›è¼‰ç¡¬ç¢Ÿèˆ‡è¨­å®šæª”
          volumeMounts:
            # A. æŒä¹…å±¤ (æ”¾ DB) -> æ›è¼‰åˆ° /app/storage
            - name: storage-volume
              mountPath: "/app/storage"
            
            # B. è¨­å®šå±¤ (æ”¾ Prompt) -> æ›è¼‰åˆ° /app/config
            - name: config-volume
              mountPath: "/app/config"
              readOnly: true
          
          # è³‡æºé™åˆ¶
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

        # --- [2] Sidecar (Tailscale) ---
        # è² è²¬è®“é€™å€‹ Pod åŠ å…¥ Tailnetï¼Œæ‰èƒ½é€£å›ä½ å®¶è£¡çš„ Mac
        #tskey-auth-kL47DQaPri11CNTRL-LPqGmjAGVAGw7ZJKSWYtAG4HPMJunSKrZ
        - name: tailscale
          image: tailscale/tailscale:latest
          env:
            - name: TS_AUTHKEY
              valueFrom:
                secretKeyRef:
                  name: tailscale-auth
                  key: TS_AUTHKEY
            - name: TS_USERSPACE
              value: "true"
            - name: TS_HOSTNAME
              value: "rag-cloud-pod"
      
      volumes:
        # å®šç¾© PVC
        - name: storage-volume
          persistentVolumeClaim:
            claimName: lancedb-pvc
        
        # å®šç¾© ConfigMap
        - name: config-volume
          configMap:
            name: rag-config
            items:
              - key: "system_prompt.txt"
                path: "system_prompt.txt"